{%- liquid
  if input_sizes
    assign sizes = input_sizes
  else
    assign sizes = '320x0,920x0'
  endif
  
  assign image_sizes = sizes | split: ","
-%}

{%- capture srcset -%}
  {%- for size in image_sizes -%}
    {%- liquid
      assign size_array = size | split: "x"
      assign size_width = size_array[0]
      assign size_height = size_array[1]

      if size_height == '0' or size_height == 0
        assign size_height = size_width | divided_by: image.aspect_ratio | round
        if size_height < 1
          assign size_height = 1
        elsif size_height > 5760
          assign size_height = 5760
        endif
      endif

      # Add mobile-specific sizes
      assign mobile_width = size_width | times: 0.5 | round
      assign mobile_height = size_height | times: 0.5 | round
      if mobile_height < 1
        assign mobile_height = 1
      elsif mobile_height > 5760
        assign mobile_height = 5760
      endif
    -%}
    {{- image | image_url: width: size_width, crop: 'center' }} {{ size_width }}w,
    {{- image | image_url: width: mobile_width, height: mobile_height, crop: 'center' }} {{ mobile_width }}w,
  {%- endfor -%}
{%- endcapture -%}

{%- liquid
  assign l = srcset | size | minus: 1

  # Get the first size from image_sizes for the href attribute
  assign first_size = image_sizes | first | split: "x"
  assign first_width = first_size[0] | plus: 0
  assign first_height = first_size[1] | plus: 0
  
  if first_height == '0' or first_height == 0
    assign first_height = first_width | divided_by: image.aspect_ratio | round
    if first_height < 1
      assign first_height = 1
    elsif first_height > 5760
      assign first_height = 5760
    endif
  endif
-%}

<link 
  rel="preload" 
  as="image" 
  href="{{ image | image_url: width: first_width, height: first_height, crop: 'center' }}"
  imagesrcset="{{ srcset | slice: 0, l | strip_newlines }}"
  imagesizes="(max-width: 767px) 50vw, 100vw"
>